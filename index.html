<!doctype html>
<html>
   <meta charset="utf-8">
   <head>
      <style>
          svg {
              border: 1px solid black;
          }
          text {
              font-size: 60px;
              text-anchor: middle;
              fill: gold;
          }
      </style>
   </head>
   <body>
      <textarea id="input" placeholder="" aceholder="Write ."></textarea>
      <button id="btnGetText">Procesar texto</button>
      <button id="btnNextInst">Clic para ejecutar siguiente instrucci√≥n</button>
      <svg id="containerSVG"  style="width: 1400px; height:900px; display: flex; flex-flow: row wrap">
         <style>
             .small{ font: italic 12px sans-serif; fill: black;}
         </style>
      </svg>
   </body>

   <script>
      function createSvg(type, svg_attributes, properties) {
         let node = document.createElementNS("http://www.w3.org/2000/svg", type);
         for (let name in svg_attributes) {
            node.setAttributeNS(null, name, svg_attributes[name]);
         }
         for (let name in properties) {
            node[name] = properties[name];
         }
         return node;
      }
      const posX = 30, posY = 30, tam = 60;
      const container = document.getElementById("containerSVG");

      let idVar = new Set( ), cx = posX, cy = posY;
      let tokens = [ ], currentInst = 0;

      const btnGetText = document.getElementById('btnGetText');
      btnGetText.addEventListener('click', function ( ){
         let line = document.getElementById('input').value.split('\n');;
         tokens = [ ], currentInst = 0; // clean vars
         for(let part of line){
            tokens.push(part.split(' '));
         }
      });


      const btnNext = document.getElementById("btnNextInst");
      btnNext.addEventListener('click', function( ){
         if(currentInst >= tokens.length){
            alert("Se terminaron de procesar las instrucciones");
            return;
         }
         const command = tokens[currentInst][0];
         if(command === "CREA"){
            const type = tokens[currentInst][1];
            const name = tokens[currentInst][2];
            if(!isUsed(name)) {
               if (type === "ARR") {
                  const num = tokens[currentInst][3];
                  createArr(name, num, 0);
               } else {
                  createVar(name, 0);
               }
               idVar.add(`svg|${name}|`);
            }else{
               alert('nombre en uso\n pasando a la siguiente instruccion');
            }

         }else if(command === 'ESCRIBE'){
            const name = tokens[currentInst][1];
            const value = tokens[currentInst][2];
            modifyBox(name, value);
         }
         currentInst++;
/*
CREA ARR bh 10
ESCRIBE bh[0] H
ESCRIBE bh[1] o
ESCRIBE bh[2] l
ESCRIBE bh[3] a
ESCRIBE bh[4]
ESCRIBE bh[5] M
ESCRIBE bh[6] u
ESCRIBE bh[7] n
ESCRIBE bh[8] d
ESCRIBE bh[9] o
 */
      });

      function isUsed(name){
         return idVar.has(`svg|${name}|`);
      }
      function createArr(name, num, value){
         if(cx + tam + tam * num >= 1400){
            cx = posX;
            cy += 150;
            if(cy >= 900 || cx + tam * num + tam >= 1400){
               alert("El arreglo es demasiado grande");
               return;
            }
         }
         //Create the name of the array
         let node = createSvg("text", { "x": cx, "y": cy + 5 + tam / 2, "text-anchor": "middle", "class": "small"}, { "textContent": name + ':'});
         node.id = `svg|${name}|`;
         container.appendChild(node);
         cx += tam / 2;

         //Create array
         for(let index = 0; index < num; ++index){
            createSpace(index, value, name);
            cx += tam;
         }
         cx += tam;
      }
      function createVar(name, value){
         if(cx + tam >= 1400){
            cx = posX;
            cy += 150;
            if(cy >= 900){
               alert("Espacio lleno");
               return;
            }
         }
         createSpace(name, value, "");
         cx += 2 * tam;
      }
      function createSpace(name, value, father){
         // Create variable's name
         let node;
         let id = (father === '' ? (`svg|${name}|`) : (`svg|${father}[${name}]|`));
         node = createSvg("text", { "x": cx + tam / 2, "y": cy + 15 + tam, "text-anchor":"middle", "class": "small"}, { "textContent": name });
         node.id = id + 'name';
         container.appendChild(node);

         //Create box variable
         node = createSvg('rect', { "x": cx, "y": cy, "width": tam, "height": tam, "fill": "white", "stroke":"black"});
         node.id = id + 'box';
         container.appendChild(node);

         //Create content
         node = createSvg("text", { "x": cx + tam / 2, "y": cy + 5 + tam / 2, "text-anchor":"middle", "class": "small"}, { "textContent": value });
         node.id = id + 'value'
         container.appendChild(node);
      }
      function modifyBox(name, value){
         let node = document.getElementById(`svg|${name}|value`);
         if(!node){
            alert('No existe la variable ' + `svg|${name}|value`);
            return;
         }
         node.textContent = value;
      }
   </script>
</html>